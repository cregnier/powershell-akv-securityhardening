# Key Vault Compliance Remediation Script
# Generated: 2026-01-08 13:49:35
# Subscription: ab1336c7-687d-4107-b0f6-9649a0458adb
# Scanned: 5 vault(s)
# Issues: 19

<#
.SYNOPSIS
    Remediate 19 Key Vault compliance issue(s)

.DESCRIPTION
    This script was auto-generated by compliance scan.
    Review each command before executing.
    
    Summary by Category:
    - Access Control: 1 issue(s)
    - Configuration: 3 issue(s)
    - Key Lifecycle: 3 issue(s)
    - Monitoring: 5 issue(s)
    - Network Security: 4 issue(s)
    - Secrets Lifecycle: 3 issue(s)

#>

# Set context
Set-AzContext -SubscriptionId 'ab1336c7-687d-4107-b0f6-9649a0458adb'

# ========================================
# Vault: kv-bl-sec-hupocgwm
# Resource Group: rg-policy-keyvault-test
# Issues: 2
# ========================================
# Issue: No firewall configured - accepts connections from all networks
# Severity: Medium
# Framework: MCSB DP-8
# Auto-remediable: False

# MANUAL CONFIGURATION REQUIRED - security requirements vary
# Option 1: Deny all, allow specific IPs
Update-AzKeyVaultNetworkRuleSet -VaultName 'kv-bl-sec-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -DefaultAction Deny -IpAddressRange @('1.2.3.4/32')
# Option 2: Allow Azure services bypass
Update-AzKeyVaultNetworkRuleSet -VaultName 'kv-bl-sec-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -Bypass AzureServices
# Issue: Diagnostic logging not configured
# Severity: Medium
# Framework: MCSB LT-3, CIS
# Auto-remediable: False

# MANUAL CONFIGURATION REQUIRED - requires Log Analytics workspace
$workspace = Get-AzOperationalInsightsWorkspace -ResourceGroupName 'rg-monitoring' -Name 'law-central'
Set-AzDiagnosticSetting -ResourceId '/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/resourceGroups/rg-policy-keyvault-test/providers/Microsoft.KeyVault/vaults/kv-bl-sec-hupocgwm' -WorkspaceId $workspace.ResourceId -Enabled $true -Category AuditEvent

# ========================================
# Vault: kv-bl-rbac-hupocgwm
# Resource Group: rg-policy-keyvault-test
# Issues: 1
# ========================================
# Issue: Diagnostic logging not configured
# Severity: Medium
# Framework: MCSB LT-3, CIS
# Auto-remediable: False

# MANUAL CONFIGURATION REQUIRED - requires Log Analytics workspace
$workspace = Get-AzOperationalInsightsWorkspace -ResourceGroupName 'rg-monitoring' -Name 'law-central'
Set-AzDiagnosticSetting -ResourceId '/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/resourceGroups/rg-policy-keyvault-test/providers/Microsoft.KeyVault/vaults/kv-bl-rbac-hupocgwm' -WorkspaceId $workspace.ResourceId -Enabled $true -Category AuditEvent

# ========================================
# Vault: kv-bl-leg-hupocgwm
# Resource Group: rg-policy-keyvault-test
# Issues: 6
# ========================================
# Issue: Purge protection is NOT enabled
# Severity: High
# Framework: CIS 8.5, MCSB DP-8
# Auto-remediable: True

Update-AzKeyVault -VaultName 'kv-bl-leg-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -EnablePurgeProtection
# Issue: Using legacy access policy model (should migrate to RBAC)
# Severity: Medium
# Framework: CIS 8.6, MCSB PA-7
# Auto-remediable: False

# MANUAL REVIEW REQUIRED - RBAC migration affects access policies
# 1. Document existing access policies
# 2. Plan RBAC role assignments
# 3. Test in non-production first
Update-AzKeyVault -VaultName 'kv-bl-leg-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -DisableRbacAuthorization $false
# Issue: No firewall configured - accepts connections from all networks
# Severity: Medium
# Framework: MCSB DP-8
# Auto-remediable: False

# MANUAL CONFIGURATION REQUIRED - security requirements vary
# Option 1: Deny all, allow specific IPs
Update-AzKeyVaultNetworkRuleSet -VaultName 'kv-bl-leg-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -DefaultAction Deny -IpAddressRange @('1.2.3.4/32')
# Option 2: Allow Azure services bypass
Update-AzKeyVaultNetworkRuleSet -VaultName 'kv-bl-leg-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -Bypass AzureServices
# Issue: Diagnostic logging not configured
# Severity: Medium
# Framework: MCSB LT-3, CIS
# Auto-remediable: False

# MANUAL CONFIGURATION REQUIRED - requires Log Analytics workspace
$workspace = Get-AzOperationalInsightsWorkspace -ResourceGroupName 'rg-monitoring' -Name 'law-central'
Set-AzDiagnosticSetting -ResourceId '/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/resourceGroups/rg-policy-keyvault-test/providers/Microsoft.KeyVault/vaults/kv-bl-leg-hupocgwm' -WorkspaceId $workspace.ResourceId -Enabled $true -Category AuditEvent
# Issue: 2 secret(s) without expiration date
# Severity: Medium
# Framework: CIS 8.3, 8.4, MCSB DP-6
# Auto-remediable: False

# MANUAL REVIEW REQUIRED - expiration periods vary by business requirements
# Example: Set 1-year expiration
Update-AzKeyVaultSecret -VaultName 'kv-bl-leg-hupocgwm' -Name 'Legacy-ConnectionString' -Expires (Get-Date).AddYears(1) Update-AzKeyVaultSecret -VaultName 'kv-bl-leg-hupocgwm' -Name 'LegacySecret' -Expires (Get-Date).AddYears(1)
# Issue: 3 key(s) without expiration date
# Severity: Medium
# Framework: MCSB DP-6
# Auto-remediable: False

# MANUAL REVIEW REQUIRED - key rotation schedules vary
# Example: Set 2-year expiration for encryption keys
Update-AzKeyVaultKey -VaultName 'kv-bl-leg-hupocgwm' -Name 'NoExpiry-RSA3072' -Expires (Get-Date).AddYears(2) Update-AzKeyVaultKey -VaultName 'kv-bl-leg-hupocgwm' -Name 'WeakEC-P256' -Expires (Get-Date).AddYears(2) Update-AzKeyVaultKey -VaultName 'kv-bl-leg-hupocgwm' -Name 'WeakEncryption-RSA2048' -Expires (Get-Date).AddYears(2)

# ========================================
# Vault: kv-bl-pub-hupocgwm
# Resource Group: rg-policy-keyvault-test
# Issues: 5
# ========================================
# Issue: Purge protection is NOT enabled
# Severity: High
# Framework: CIS 8.5, MCSB DP-8
# Auto-remediable: True

Update-AzKeyVault -VaultName 'kv-bl-pub-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -EnablePurgeProtection
# Issue: No firewall configured - accepts connections from all networks
# Severity: Medium
# Framework: MCSB DP-8
# Auto-remediable: False

# MANUAL CONFIGURATION REQUIRED - security requirements vary
# Option 1: Deny all, allow specific IPs
Update-AzKeyVaultNetworkRuleSet -VaultName 'kv-bl-pub-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -DefaultAction Deny -IpAddressRange @('1.2.3.4/32')
# Option 2: Allow Azure services bypass
Update-AzKeyVaultNetworkRuleSet -VaultName 'kv-bl-pub-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -Bypass AzureServices
# Issue: Diagnostic logging not configured
# Severity: Medium
# Framework: MCSB LT-3, CIS
# Auto-remediable: False

# MANUAL CONFIGURATION REQUIRED - requires Log Analytics workspace
$workspace = Get-AzOperationalInsightsWorkspace -ResourceGroupName 'rg-monitoring' -Name 'law-central'
Set-AzDiagnosticSetting -ResourceId '/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/resourceGroups/rg-policy-keyvault-test/providers/Microsoft.KeyVault/vaults/kv-bl-pub-hupocgwm' -WorkspaceId $workspace.ResourceId -Enabled $true -Category AuditEvent
# Issue: 2 secret(s) without expiration date
# Severity: Medium
# Framework: CIS 8.3, 8.4, MCSB DP-6
# Auto-remediable: False

# MANUAL REVIEW REQUIRED - expiration periods vary by business requirements
# Example: Set 1-year expiration
Update-AzKeyVaultSecret -VaultName 'kv-bl-pub-hupocgwm' -Name 'Legacy-ConnectionString' -Expires (Get-Date).AddYears(1) Update-AzKeyVaultSecret -VaultName 'kv-bl-pub-hupocgwm' -Name 'PublicSecret' -Expires (Get-Date).AddYears(1)
# Issue: 5 key(s) without expiration date
# Severity: Medium
# Framework: MCSB DP-6
# Auto-remediable: False

# MANUAL REVIEW REQUIRED - key rotation schedules vary
# Example: Set 2-year expiration for encryption keys
Update-AzKeyVaultKey -VaultName 'kv-bl-pub-hupocgwm' -Name 'NoExpiry-RSA3072' -Expires (Get-Date).AddYears(2) Update-AzKeyVaultKey -VaultName 'kv-bl-pub-hupocgwm' -Name 'WeakEC-P256' -Expires (Get-Date).AddYears(2) Update-AzKeyVaultKey -VaultName 'kv-bl-pub-hupocgwm' -Name 'WeakECKey' -Expires (Get-Date).AddYears(2) Update-AzKeyVaultKey -VaultName 'kv-bl-pub-hupocgwm' -Name 'WeakEncryption-RSA2048' -Expires (Get-Date).AddYears(2) Update-AzKeyVaultKey -VaultName 'kv-bl-pub-hupocgwm' -Name 'WeakRSAKey' -Expires (Get-Date).AddYears(2)

# ========================================
# Vault: kv-bl-log-hupocgwm
# Resource Group: rg-policy-keyvault-test
# Issues: 5
# ========================================
# Issue: Purge protection is NOT enabled
# Severity: High
# Framework: CIS 8.5, MCSB DP-8
# Auto-remediable: True

Update-AzKeyVault -VaultName 'kv-bl-log-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -EnablePurgeProtection
# Issue: No firewall configured - accepts connections from all networks
# Severity: Medium
# Framework: MCSB DP-8
# Auto-remediable: False

# MANUAL CONFIGURATION REQUIRED - security requirements vary
# Option 1: Deny all, allow specific IPs
Update-AzKeyVaultNetworkRuleSet -VaultName 'kv-bl-log-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -DefaultAction Deny -IpAddressRange @('1.2.3.4/32')
# Option 2: Allow Azure services bypass
Update-AzKeyVaultNetworkRuleSet -VaultName 'kv-bl-log-hupocgwm' -ResourceGroupName 'rg-policy-keyvault-test' -Bypass AzureServices
# Issue: Diagnostic logging not configured
# Severity: Medium
# Framework: MCSB LT-3, CIS
# Auto-remediable: False

# MANUAL CONFIGURATION REQUIRED - requires Log Analytics workspace
$workspace = Get-AzOperationalInsightsWorkspace -ResourceGroupName 'rg-monitoring' -Name 'law-central'
Set-AzDiagnosticSetting -ResourceId '/subscriptions/ab1336c7-687d-4107-b0f6-9649a0458adb/resourceGroups/rg-policy-keyvault-test/providers/Microsoft.KeyVault/vaults/kv-bl-log-hupocgwm' -WorkspaceId $workspace.ResourceId -Enabled $true -Category AuditEvent
# Issue: 1 secret(s) without expiration date
# Severity: Medium
# Framework: CIS 8.3, 8.4, MCSB DP-6
# Auto-remediable: False

# MANUAL REVIEW REQUIRED - expiration periods vary by business requirements
# Example: Set 1-year expiration
Update-AzKeyVaultSecret -VaultName 'kv-bl-log-hupocgwm' -Name 'Legacy-ConnectionString' -Expires (Get-Date).AddYears(1)
# Issue: 3 key(s) without expiration date
# Severity: Medium
# Framework: MCSB DP-6
# Auto-remediable: False

# MANUAL REVIEW REQUIRED - key rotation schedules vary
# Example: Set 2-year expiration for encryption keys
Update-AzKeyVaultKey -VaultName 'kv-bl-log-hupocgwm' -Name 'NoExpiry-RSA3072' -Expires (Get-Date).AddYears(2) Update-AzKeyVaultKey -VaultName 'kv-bl-log-hupocgwm' -Name 'WeakEC-P256' -Expires (Get-Date).AddYears(2) Update-AzKeyVaultKey -VaultName 'kv-bl-log-hupocgwm' -Name 'WeakEncryption-RSA2048' -Expires (Get-Date).AddYears(2)

Write-Host "
Remediation complete. Review results and update compliance dashboard." -ForegroundColor Green
